<head>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script type="text/javascript">

        var currentQuestion = "";
        var myAnswer = "";
        var poll_results_interval;


        function handle_update_list_options(question, options) {
            return function (data) {
                if (data[0] === currentQuestion) {
                    return
                }
                currentQuestion = data[0];

                document.getElementById("resultDiv").style.display = "none";
                document.getElementById("answerPoll").style.display = "block";
                $(options).empty();

                data.forEach(function (item, index) {
                    if (index === 0) {
                        $(question).text(item)
                    } else {
                        $(options).append('<option value="' + item + '">' + item + '</option>');
                    }
                })
            }
        }

        function update_poll_options() {
            $.ajax("/poll", {
                dataType: "json",
                success: handle_update_list_options("#asked","#answer")
            })
        }


        function handle_poll_results() {
            return function (data) {
                if (myAnswer === "") {
                    return
                }

                var str = '<table class="table table-striped">';
                Object.entries(data).forEach(function (mapEntry) {
                    var option = mapEntry[0];
                    var votes = mapEntry[1];
                    str += "<tr><th>" + option + "</th><th> got </th><th>" + votes + "</th><th> votes </th></tr>";
                });
                str += "</table>";

                $("#results").html(str);
                clearInterval(poll_results_interval)
            }
        }

        function update_poll_results() {
            $.ajax("/vote", {
                dataType: "json",
                success: handle_poll_results()
            })
        }

        function start_poll() {
            $.post("/poll", $("#question").val() + "\n" + $("#options").val(), update_poll_options)
        }

        function send_poll_answer() {
            if (currentQuestion === "") {
                return
            }
            myAnswer = $("answer").val();
            $.post("/vote", $("#answer").val());
            document.getElementById("resultDiv").style.display = "block";
            document.getElementById("answerPoll").style.display = "none";

            $("#results").html("Waiting for the results...");

            poll_results_interval = setInterval(update_poll_results, 2000)
        }


        setInterval(update_poll_options, 1000);

    </script>
</head>

<body>
<div class="container" id="2288">
<h1>Peerster PollParty</h1>

<h2>Start Poll</h2>
Question: <br> <input id="question">
<p>
Options (one per line): <br> <textarea id="options"></textarea>
<p>
<button class="btn btn-primary" onclick="start_poll()">Ask!</button>

<br><br>
<h2>Ongoing Poll</h2>
<div id="answerPoll">
    Question: <br>
    <textarea id="asked" disabled></textarea>
    <p>
    Choose your answer:
    <select id="answer">
        <!-- <option value="opt1"> option 1 </option>
        <option value="opt2"> option 2 </option> -->
    </select>
    <button class="btn btn-primary" onclick="send_poll_answer()">Vote!</button>
</div>
<div id="resultDiv" style="display: none">
    <h3>Results</h3>
    <label id="results">

    </label>
</div>
</div>
</body>
